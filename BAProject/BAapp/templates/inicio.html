{% extends 'base.html' %}
{% block imports %}
   {% load static %}
{% endblock imports %}
{% block style%}

body {
  background-color: #96f291;
}

/* Chrome, Safari, Edge, Opera */
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Firefox */
input[type=number] {
  -moz-appearance: textfield;
}

{% endblock style%}
{% block title %}
BuenaVentura Agronegocios
{% endblock title %}   
{%block body%}
<div class="row hide">
    
    <div class="col s12">
        <div class="card grey darken-3"> 
            <span class=" col s2 right-align  bottom-aling grey-text">Cliente:</span>
            <span class="card-title col s3 white-text">Arguello ramiro </span>
            <span class=" col s2 right-align bottom-aling grey-text">Empresa:</span>
            <span class="card-title col s3 green-text"> Speedagro </span>
            <a class=" grey darken-3 yellow-text btn-flat waves-effect waves-light modal-trigger pulse " href="#modal-empresa"><i class="material-icons right ">info_outline</i>Modificar</a>
        </div>
    </div>

  </div>
  <div class="float: right; row">
    <div class="col s12 m8">
      <div class="card blue-grey darken-1">
        <div class="card-content white-text">
          <span class="card-title center-align"> Agrege los articulos en los que esta interesado</span>
          <span class="left-align">Vendedor: </span>
          <b><span class="left-align" id="vendedor">{{ user.get_username }}</span></b><br>
          <span class="left-align">Seleccione un comprador:</span><br>
          <div class="row left-align col s6">
            <input type="text" id="inputComp" list="datalistComp">
            <datalist id="datalistComp"></datalist>
          </div>
          <br>
            <table id="empTable">
              <thead>
              <tr class="grey darken-1">
                <th>Ingrediente</th>
                <th>Marca</th>
                <th>Precio X unidad</th>
                <th>Cantidad</th>
                <th>Financiamiento</th>
                <th>Estado</th>
                </tr>
            </thead>
            <tbody id="body"></tbody>
          </table>
          <br>
          
          <div class="row">
            <a class="blue waves-effect waves-light btn col s6 tooltipped" data-tooltip="Añadir una fila" onclick="addRow()">Agregar Artículo</a> 
            <a  class="red waves-effect waves-light btn col s6  tooltipped" data-position="right" data-tooltip="Eliminar ultima fila" onclick="removeRow()">Eliminar Articulo</a> 
          </div>
          <div class="row" id="divProp" style="display:none">
            <a class="green waves-effect waves-light col s12 btn" onclick="showModal()">Realizar Propuesta</a>
          
          </div>
        </div>
      </div>
    </div>
</div>

<!--
  <i class="material-icons">cancel</i>
  <i class="material-icons">add</i>
-->
<br>


  <div class="fixed-action-btn">
    <a class="btn-floating btn-large red">
      <i class="large material-icons">dehaze</i>
    </a>
    <ul>
      <li><a class="btn-floating green tooltipped" data-position="left"  data-tooltip="ir a Whatsapp"><i class="material-icons">call</i></a></li>
      <li><a class="btn-floating blue tooltipped" data-position="left"  data-tooltip="Reutilizar pedido "><i class="material-icons">cached</i></a></li>
      <li><a class="btn-floating orange tooltipped" data-position="left"  data-tooltip="Nuevo Pedido"><i class="material-icons">add_circle</i></a></li>
    </ul>
  </div>

  <div id="modal1" class="modal">
    <div class="modal-content">
      <h4>Advertencia!</h4>
      <p>¿Desea realizar una Propuesta ?</p>
    </div>
    <div class="modal-footer">
      <a onclick="submit()" class="modal-close waves-effect waves-green btn-flat"><i class="material-icons">check</i></a>
    </div>
  </div>

<script>

document.addEventListener('DOMContentLoaded', function() {
    var elems = document.querySelectorAll('#botonsito');
    var instances = M.FloatingActionButton.init(elems, {
      direction: 'right',
      hoverEnabled: false
    });
  });

$(document).ready(function(){
    $('.fixed-action-btn').floatingActionButton();
  });
 $(document).ready(function(){
    $('.tooltipped').tooltip();
  });

  $(document).ready(function(){
    $('.modal').modal();
  });

   $(document).ready(function(){
    $('select').formSelect();
  });    

  $(document).ready(function(){
    $('.datepicker').datepicker();
  }); 


var headers = [];
var savings_data;
var compradores_data;
  $(document).ready(function(){
  $("#empTable thead tr th").each(function(index){
    if ($(this).text() != "Operaciones"){
      headers.push($(this).text())
    }
  })
    $.ajax({
      type: "GET",
      url: "{% url 'api_articulos' %}",
      dataType: "json",
      success: function(data) {      
        savings_data = data;
      }
    });
    hideSend();
  });

  $(document).ready(function(){
    $.ajax({
      type: "GET",
      url: "{% url 'api_comprador' %}",
      dataType: "json",
      success: function(data) {      
        compradores_data = data;
        var datalistComp = document.getElementById("datalistComp");
        for (var i = 0; i < compradores_data.length; i++) {
            var optionComp = document.createElement('option');
            optionComp.setAttribute('value',''+compradores_data[i]['usuario']+'');
            optionComp.setAttribute('id','option'+i);
            datalistComp.appendChild(optionComp);        
          }
      }
    });
    hideSend();
  });


  function hideSend(){
    var bodyT = document.getElementById('body');
    var rowCnt = bodyT.rows.length;
    var divS = document.getElementById("divProp");
    if (rowCnt < 1){
      divS.style.display = "none";
    }else {
      divS.style.display = "block";
    }
  };

function addRow() {
  var defaultPlace = ["0.00", "0.00", "----", '----']
  var empTab = document.getElementById('body');
  var rowCnt = empTab.rows.length;    // numero de columnas
  var tr = empTab.insertRow(rowCnt); // numero de filas
  for (var c = 0; c < headers.length; c++) {             
    var td = document.createElement('td');       
    td = tr.insertCell(c);
    if (c==0) {
      var ele = document.createElement('input');
      ele.setAttribute('type', 'text');
      ele.setAttribute('id', 'input'+(rowCnt)+'.'+c+'');
      ele.setAttribute('list', 'datalist'+(rowCnt)+'');
      ele.setAttribute('onchange','refreshMarca("'+rowCnt+'.'+c+'")');
      ele.setAttribute('onclick','this.select();');
      ele.setAttribute('placeholder', 'Ingrediente');
      var datalistIng = document.createElement('datalist');
      datalistIng.setAttribute('id', 'datalist'+(rowCnt)+'');
      
      td.appendChild(ele);
      td.appendChild(datalistIng);
      for (var i = 0; i < savings_data.length; i++) {
        var optionIng = document.createElement('option');
        optionIng.setAttribute('value',''+savings_data[i].ingrediente+'');
        datalistIng.appendChild(optionIng);        

      }
    }else if(c==1){      
      var ele = document.createElement('input');
      ele.setAttribute('type', 'text');
      ele.setAttribute('id', 'input'+(rowCnt)+'.'+c+'');
      ele.setAttribute('list', 'datalist'+(rowCnt)+'.'+(rowCnt)+'');
      ele.setAttribute('onclick','this.select();');
      ele.setAttribute('placeholder', 'Marca');
      var datalistMar = document.createElement('datalist');
      datalistMar.setAttribute('id', 'datalist'+(rowCnt)+'.'+(rowCnt)+'');
      
      td.appendChild(ele);
      td.appendChild(datalistMar);
      for (var i = 0; i < savings_data.length; i++) {
        var optionMar = document.createElement('option');
        optionMar.setAttribute('value',''+savings_data[i].marca+'');
        optionMar.setAttribute('id','option'+i);
        datalistMar.appendChild(optionMar);        
      }
    }else{
      var ele = document.createElement('input');
      ele.setAttribute('type', 'text');
      ele.setAttribute('id', 'input'+(rowCnt)+'.'+c+'');
      var pl = defaultPlace[c-2];
      ele.setAttribute('placeholder', pl);
      td.appendChild(ele);
    };
  }
  hideSend();
};

function refreshMarca(inputId){
  var tmp = (inputId.substring(0,1));
  var input = document.getElementById('input'+inputId).value;
  var datalist = document.getElementById('datalist'+tmp+'.'+tmp);

  var url = "{% url 'filterArticulo' "replace" %}";
  url = url.replace('replace',input);
  $.ajax({
    type: "GET",
    url: url,
    dataType: "json",
    success: function(data) {    
      datalist.innerHTML = " ";
      for (var i = 0; i < data.length; i++) {
        var option = document.createElement('option');
        option.setAttribute('value',''+data[i].marca+'');
        option.setAttribute('id','option'+i);
        datalist.appendChild(option);
      }
    }
  });
}

function removeRow(){
  var empTab = document.getElementById('body');
  var rowCnt = empTab.rows.length;    // numero de columnas
  empTab.deleteRow(rowCnt-1); // numero de filas
  hideSend();
}

function showModal(){
  $('#modal1').modal('open');
};

function submit(){
  var dict = [];
  var empTab = document.getElementById('body');
  var inputComp = document.getElementById('inputComp');
  var vendedor = document.getElementById('vendedor');
  var rowCnt = empTab.rows.length;    // numero de columnas
   for (var i = 0; i < rowCnt; i++) {
    var tmp_dict = {};
    for (var j = 0; j < headers.length; j++) {
      var input = document.getElementById('input'+i+'.'+j+'');
      var tmp = {};
      tmp_dict[headers[j]] = input.value;
    }
    dict.push(tmp_dict);
   }
   var aux_dict = {
      'data':dict,
      'comprador':inputComp.value,
      'vendedor':vendedor.value,
   }
   console.log("--------");
   console.log(aux_dict);
   fetch("{% url 'api_articulos' %}",{
    method:'POST',
    headers: {
      [window.drf.csrfHeaderName]:window.drf.csrfToken,
      'Content-Type':'application/x-www-form-urlencoded;charset=utf-8',
    },
    body: JSON.stringify(aux_dict),
   }).then(console.log);
};
  </script>
{% endblock body %}